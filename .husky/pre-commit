#!/bin/sh
# Pre-commit hook: Run local migrations before committing

echo "üîç Checking for new migrations..."

# Get list of staged migration files
STAGED_MIGRATIONS=$(git diff --cached --name-only | grep "^migrations/.*\.sql$" || true)

if [ -n "$STAGED_MIGRATIONS" ]; then
    echo "üìÅ Found staged migrations:"
    echo "$STAGED_MIGRATIONS"
    echo ""
    echo "üîÑ Running migrations against LOCAL database..."
    echo "   (Production migrations must be run separately!)"
    echo ""
    
    # Run migrations
    if node scripts/run-migrations.mjs; then
        echo "‚úÖ Local migrations completed"
        echo ""
        echo "‚ö†Ô∏è  REMEMBER: Production database needs manual migration!"
        echo "   Run: npx supabase db push"
        echo "   Or:  Copy SQL to Supabase Dashboard SQL Editor"
        echo ""
    else
        echo "‚ùå Migration failed! Fix errors before committing."
        exit 1
    fi
else
    echo "‚úì No new migrations to run"
fi

exit 0
