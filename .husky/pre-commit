#!/bin/sh
# Pre-commit hook: Run migrations before committing

echo "üîç Checking for new migrations..."

# Check if any migration files are staged
STAGED_MIGRATIONS=$(git diff --cached --name-only | grep "^migrations/.*\.sql$" || true)

if [ -n "$STAGED_MIGRATIONS" ]; then
    echo "üìÅ Found staged migrations:"
    echo "$STAGED_MIGRATIONS"
    echo ""
    echo "üîÑ Running migrations against local database..."
    
    # Run migrations
    if node scripts/run-migrations.mjs; then
        echo "‚úÖ Migrations completed successfully"
    else
        echo "‚ùå Migration failed! Fix errors before committing."
        exit 1
    fi
else
    echo "‚úì No new migrations to run"
fi

# Check if migrations folder has uncommitted changes
MIGRATION_STATUS=$(git status --short migrations/ 2>/dev/null || true)
if [ -n "$MIGRATION_STATUS" ]; then
    echo "‚ö†Ô∏è  Warning: You have uncommitted migration changes:"
    echo "$MIGRATION_STATUS"
    echo ""
    echo "Consider committing migrations first, then code changes."
fi

echo ""
echo "‚úÖ Pre-commit checks passed"
exit 0
